# Sagan msapi-exchange.rules
# Copyright (c) 2009-2023. Quadrant Information Security <www.quadrantsec.com>
# All rights reserved.
#
# Please submit any custom rules or ideas to sagan-submit@quadrantsec.com or the sagan-sigs mailing list
#
#*************************************************************
#  Redistribution and use in source and binary forms, with or without modification, are permitted provided that the
#  following conditions are met:
#
#  * Redistributions of source code must retain the above copyright notice, this list of conditions and the following
#    disclaimer.
#  * Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the
#    following disclaimer in the documentation and/or other materials provided with the distribution.
#  * Neither the name of the nor the names of its contributors may be used to endorse or promote products derived
#    from this software without specific prior written permission.
#
#  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY EXPRESS OR IMPLIED WARRANTIES,
#  INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
#  DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
#  SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
#  SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
#  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE
#  USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#
#*************************************************************
#
# These rules are for the Office 365 Management API
# https://docs.microsoft.com/en-us/office/office-365-management-api/office-365-management-apis-overview
#
# These rules work best with a JSON input map.  See the "msapi" mapping.  See the Sagan
# JSON documentation for more information
#
#Reference: https://learn.microsoft.com/en-us/exchange/client-developer/web-service-reference/ews-operations-in-exchange

alert any $HOME_NET any -> $EXTERNAL_NET any (msg: "[MSAPI-EXCHANGE] Data Loss Prevention Rule Match"; json_content: ".Workload","Exchange"; json_content: ".Operation", "DlpRuleMatch"; json_map: "src_ip", ".ClientIP"; json_map: "dest_ip", ".ClientIP"; json_map: "username", ".UserID"; json_map: "program",".Workload"; classtype: misc-attack; sid:5004863; rev: 3; metadata: mitre_technique_id T1008, mitre_technique_id T1048, mitre_technique_id T1114;)

alert any $HOME_NET any -> $HOME_NET any (msg:"[MSAPI-EXCHANGE] Admin Audit New-InboxRule Created w/ Forwarding"; program:Exchange; json_content:".Operation","New-InboxRule"; meta_content:"Name|5c 22 3a 5c 22|%sagan%",RedirectTo,ForwardTo,ForwardAsAttachmentTo; json_map:"src_ip",".ClientIP"; normalize; reference:url,https://redcanary.com/blog/threat-detection/email-forwarding-rules/; reference:url,https://www.splunk.com/en_us/blog/security/hunting-m365-invaders-dissecting-email-collection-techniques.html; classtype:suspicious-activity; sid:5015346; rev:1; metadata:created_at 2025_03_11, updated_at 2025_03_11, mitre_tactic_id TA0009, mitre_technique_id T1114;)
alert any $HOME_NET any -> $HOME_NET any (msg:"[MSAPI-EXCHANGE] Admin Audit Set-InboxRule Created w/ Forwarding"; program:Exchange; json_content:".Operation","Set-InboxRule"; meta_content:"Name|5c 22 3a 5c 22|%sagan%",RedirectTo,ForwardTo,ForwardAsAttachmentTo; json_map:"src_ip",".ClientIP"; normalize; reference:url,https://redcanary.com/blog/threat-detection/email-forwarding-rules/; reference:url,https://www.splunk.com/en_us/blog/security/hunting-m365-invaders-dissecting-email-collection-techniques.html; classtype:suspicious-activity; sid:5015347; rev:1; metadata:created_at 2025_03_11, updated_at 2025_03_11, mitre_tactic_id TA0009, mitre_technique_id T1114;)
alert any $HOME_NET any -> $HOME_NET any (msg:"[MSAPI-EXCHANGE] Admin Audit Set-Mailbox Created w/ Forwarding"; program:Exchange; json_content:".Operation","Set-Mailbox"; meta_content:"Name|5c 22 3a 5c 22|%sagan%",ForwardingSmtpAddress,ForwardingAddress,DeliverToMailboxandForward; content:!"|22|ForwardingAddress|5c 22 2c 5c 22|Value|5c 22 3a 5c 22 5c 22 7d 2c 7b 5c 22|Name|5c 22 3a 5c 22|ForwardingSmtpAddress|5c 22 2c 5c 22|Value|5c 22 3a 5c 22 5c 22|"; json_map:"src_ip",".ClientIP"; normalize; reference:url,https://redcanary.com/blog/threat-detection/email-forwarding-rules/; reference:url,https://www.splunk.com/en_us/blog/security/hunting-m365-invaders-dissecting-email-collection-techniques.html; classtype:suspicious-activity; sid:5015348; rev:1; metadata:created_at 2025_03_11, updated_at 2025_05_28, mitre_tactic_id TA0009, mitre_technique_id T1114;)
alert any $HOME_NET any -> $HOME_NET any (msg:"[MSAPI-EXCHANGE] Audit UpdateInboxRules Detected w/ Forwarding"; program:Exchange; json_content:".Operation","UpdateInboxRule"; meta_content:"Name|5c 22 3a 5c 22|%sagan%",Forward,Recipients; json_map:"src_ip",".ClientIP"; normalize; reference:url,https://redcanary.com/blog/threat-detection/email-forwarding-rules/; reference:url,https://www.splunk.com/en_us/blog/security/hunting-m365-invaders-dissecting-email-collection-techniques.html; classtype:suspicious-activity; sid:5015349; rev:1; metadata:created_at 2025_03_11, updated_at 2025_03_11, mitre_tactic_id TA0009, mitre_technique_id T1114;)
alert any $HOME_NET any -> $HOME_NET any (msg:"[MSAPI-EXCHANGE] Admin Audit New-TransportRule Created w/ Forwarding"; program:Exchange; json_content:".Operation","New-TransportRule"; meta_content:"Name|5c 22 3a 5c 22|%sagan%",BlindCopyTo,CopyTo,RedirectMessageTo; json_map:"src_ip",".ClientIP"; normalize; reference:url,https://redcanary.com/blog/threat-detection/email-forwarding-rules/; reference:url,https://www.splunk.com/en_us/blog/security/hunting-m365-invaders-dissecting-email-collection-techniques.html; classtype:suspicious-activity; sid:5015350; rev:1; metadata:created_at 2025_03_11, updated_at 2025_03_11, mitre_tactic_id TA0009, mitre_technique_id T1114;)
alert any $HOME_NET any -> $HOME_NET any (msg:"[MSAPI-EXCHANGE] Admin Audit Set-TransportRule Created w/ Forwarding"; program:Exchange; json_content:".Operation","Set-TransportRule"; meta_content:"Name|5c 22 3a 5c 22|%sagan%",BlindCopyTo,CopyTo,RedirectMessageTo; json_map:"src_ip",".ClientIP"; normalize; reference:url,https://cardinalops.com/blog/cardinalops-contributes-new-mitre-attck-techniques-related-to-abuse-of-mail-transport-rules/; reference:url,https://www.splunk.com/en_us/blog/security/hunting-m365-invaders-dissecting-email-collection-techniques.html; classtype:suspicious-activity; sid:5015351; rev:1; metadata:created_at 2025_03_11, updated_at 2025_03_11, mitre_tactic_id TA0009, mitre_technique_id T1114;)
alert any $HOME_NET any -> $HOME_NET any (msg:"[MSAPI-EXCHANGE] Audit MailboxLogin from Outside $HOME_COUNTRY"; program:Exchange; json_content:".Operation","MailboxLogin"; json_content:".ResultStatus","Successful"; country_code:track by_src,isnot $HOME_COUNTRY; json_map:"src_ip",".ClientIP"; normalize; reference:url,https://redcanary.com/blog/threat-detection/email-forwarding-rules/; reference:url,https://www.splunk.com/en_us/blog/security/hunting-m365-invaders-dissecting-email-collection-techniques.html; classtype:suspicious-activity; sid:5015352; rev:1; metadata:created_at 2025_03_11, updated_at 2025_03_11, mitre_tactic_id TA0009, mitre_technique_id T1114;)
alert any $HOME_NET any -> $HOME_NET any (msg:"[MSAPI-EXCHANGE] Admin Audit Add-MailboxPermission FullAccess"; program:Exchange; json_content:".Operation","Add-MailboxPermission"; meta_content:"Value|5c 22 3a 5c 22|%sagan%",FullAccess; json_map:"src_ip",".ClientIP"; normalize; reference:url,https://github.com/PwC-IR/Business-Email-Compromise-Guide/blob/main/PwC-Business_Email_Compromise-Guide.pdf; classtype:suspicious-activity; sid:5015353; rev:1; metadata:created_at 2025_03_11, updated_at 2025_03_11, mitre_tactic_id TA0009, mitre_technique_id T1114;)
alert any $HOME_NET any -> $HOME_NET any (msg:"[MSAPI-EXCHANGE] Admin Audit Add-RecipientPermission SendAs Set"; program:Exchange; json_content:".Operation","Add-RecipientPermission"; meta_content:"Value|5c 22 3a 5c 22|%sagan%",SendAs; json_map:"src_ip",".ClientIP"; normalize; reference:url,https://github.com/PwC-IR/Business-Email-Compromise-Gide; classtype:suspicious-activity; sid:5015354; rev:1; metadata:created_at 2025_03_11, updated_at 2025_03_11, mitre_tactic_id TA0009, mitre_technique_id T1114;)
alert any $HOME_NET any -> $HOME_NET any (msg:"[MSAPI-EXCHANGE] Admin Audit Set-AdminAuditLogConfig Disable Logging"; program:Exchange; json_content:".Operation","Set-AdminAuditLogConfig"; meta_content:"Name|5c 22 3a 5c 22|%sagan%",AdminAuditLogEnabled; content:"Value|5c 22 3a 5c 22|False"; json_map:"src_ip",".ClientIP"; normalize; reference:url,https://github.com/PwC-IR/Business-Email-Compromise-Gide; reference:url,https://learn.microsoft.com/en-us/exchange/policy-and-compliance/admin-audit-logging/manage-admin-audit-logging?view=exchserver-2019; classtype:suspicious-activity; sid:5015355; rev:1; metadata:created_at 2025_03_11, updated_at 2025_03_11, mitre_tactic_id TA0009, mitre_technique_id T1114;)
alert any $HOME_NET any -> $HOME_NET any (msg:"[MSAPI-EXCHANGE] Admin Audit Inbox Rule w/ DeleteMessage"; program:Exchange; json_content:".Operation","-InboxRule"; json_contains; content:"Name|5c 22 3a 5c 22|DeleteMessage"; json_map:"src_ip",".ClientIP"; normalize; reference:url,https://redcanary.com/blog/threat-detection/email-forwarding-rules/; reference:url,https://www.splunk.com/en_us/blog/security/hunting-m365-invaders-dissecting-email-collection-techniques.html; classtype:suspicious-activity; sid:5015500; rev:1; metadata:created_at 2025_03_11, updated_at 2025_03_11, mitre_tactic_id TA0009, mitre_technique_id T1114;)
alert any $HOME_NET any -> $HOME_NET any (msg:"[MSAPI-EXCHANGE] Audit MailboxLogin Brute-Force Password Spray [10/60]"; program:Exchange; json_content:".Operation","MailboxLogin"; json_content:".ResultStatus","Successful"; after:track by_username,count 10,seconds 60; threshold:type suppress,track by_username,count 1, seconds 14400; flexbits:set,password-spray,14400; json_map:"src_ip",".ClientIP"; json_map:"username",".UserId"; reference:url,https://redcanary.com/blog/threat-detection/email-forwarding-rules/; reference:url,https://www.splunk.com/en_us/blog/security/hunting-m365-invaders-dissecting-email-collection-techniques.html; classtype:suspicious-activity; sid:5015830; rev:1; metadata:created_at 2025_03_11, updated_at 2025_03_11, mitre_tactic_id TA0009, mitre_technique_id T1114;)
alert any $HOME_NET any -> $HOME_NET any (msg:"[MSAPI-EXCHANGE] Audit MailboxLogin Login After Brute-Force"; program:Exchange; json_content:".Operation","MailboxLogin"; json_content:".ResultStatus","Successful"; flexbits:isset,username,password-spray; json_map:"src_ip",".ClientIP"; json_map:"username",".UserId"; reference:url,https://redcanary.com/blog/threat-detection/email-forwarding-rules/; reference:url,https://www.splunk.com/en_us/blog/security/hunting-m365-invaders-dissecting-email-collection-techniques.html; classtype:suspicious-activity; sid:5015831; rev:1; metadata:created_at 2025_03_11, updated_at 2025_03_11, mitre_tactic_id TA0009, mitre_technique_id T1114;)
alert any $HOME_NET any -> $HOME_NET any (msg:"[MSAPI-EXCHANGE] Audit MailboxLogin Brute-Force [25/60]"; program:Exchange; json_content:".Operation","MailboxLogin"; json_content:".ResultStatus","Successful"; after:track by_src,count 10,seconds 60; threshold:type suppress,track by_src,count 1, seconds 14400; xbits:set,brute-force,track ip_src,expire 14400; json_map:"src_ip",".ClientIP"; json_map:"username",".UserId"; reference:url,https://redcanary.com/blog/threat-detection/email-forwarding-rules/; reference:url,https://www.splunk.com/en_us/blog/security/hunting-m365-invaders-dissecting-email-collection-techniques.html; classtype:suspicious-activity; sid:5015832; rev:1; metadata:created_at 2025_03_11, updated_at 2025_03_11, mitre_tactic_id TA0009, mitre_technique_id T1114;)
alert any $HOME_NET any -> $HOME_NET any (msg:"[MSAPI-EXCHANGE] Audit MailboxLogin Login After Brute-Force"; program:Exchange; json_content:".Operation","MailboxLogin"; json_content:".ResultStatus","Successful"; xbits:isset,brute-force,track ip_src; json_map:"src_ip",".ClientIP"; json_map:"username",".UserId"; reference:url,https://redcanary.com/blog/threat-detection/email-forwarding-rules/; reference:url,https://www.splunk.com/en_us/blog/security/hunting-m365-invaders-dissecting-email-collection-techniques.html; classtype:suspicious-activity; sid:5015833; rev:1; metadata:created_at 2025_03_11, updated_at 2025_03_11, mitre_tactic_id TA0009, mitre_technique_id T1114;)

#generic rules
#alert any $HOME_NET any -> $HOME_NET any (msg:"[MSAPI-EXCHANGE] Admin Audit New-InboxRule Created"; program:Exchange; json_content:".Operation","New-InboxRule"; json_map:"src_ip",".ClientIP"; normalize; classtype:suspicious-activity; sid:5015356; rev:1; metadata:created_at 2025_03_11, updated_at 2025_03_11, mitre_tactic_id TA0009, mitre_technique_id T1114;)
#alert any $HOME_NET any -> $HOME_NET any (msg:"[MSAPI-EXCHANGE] Admin Audit Set-InboxRule Created"; program:Exchange; json_content:".Operation","Set-InboxRule"; json_map:"src_ip",".ClientIP"; normalize; classtype:suspicious-activity; sid:5015357; rev:1; metadata:created_at 2025_03_11, updated_at 2025_03_11, mitre_tactic_id TA0009, mitre_technique_id T1114;)
#alert any $HOME_NET any -> $HOME_NET any (msg:"[MSAPI-EXCHANGE] Admin Audit Enable-InboxRule Created"; program:Exchange; json_content:".Operation","Enable-InboxRule"; json_map:"src_ip",".ClientIP"; normalize; classtype:suspicious-activity; sid:5015358; rev:1; metadata:created_at 2025_03_11, updated_at 2025_03_11, mitre_tactic_id TA0009, mitre_technique_id T1114;)
